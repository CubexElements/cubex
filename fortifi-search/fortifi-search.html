<link href="../../polymer/polymer.html" rel="import">
<link rel="import" href="../../paper-input/paper-input.html">
<link rel="import" href="../../paper-styles/shadow.html">
<link rel="import" href="../../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../fort-icon/fort-icon.html">
<link rel="import" href="fortifi-search-overlay.html">

<dom-module id="fortifi-search" attributes="focus-search">
  <template>
    <style>
      :host {
        margin: 0 12px;
        display: none;
        line-height: 12px;
        --paper-input-container-underline: {
          display: none;
        };
        --paper-input-container-underline-focus: {
          display: none;
        };

        --iron-overlay-backdrop: {
          top: 64px;
        };

        --iron-overlay-backdrop-opened: {
          display: none;
        };
      }

      paper-input {
        text-align: left;
        --paper-input-container: {
          background: rgba(255, 255, 255, 0.1);
        };
        border-bottom: 2px solid transparent;
      }

      paper-input:not([focused]) {
        --paper-input-container-label: {
          display: none;
        }
      }

      paper-input[focused] {
        @apply --shadow-elevation-2dp;
        border-bottom-color: var(--accent-400-color);
        background: var(--theme-100-color);
      }

      paper-input[focused] fort-icon {
        color: var(--theme-text-secondary);
      }

      paper-input fort-icon {
        margin: 0 12px;
      }

      :host([focus-search]) {
        display: block;
        width: 295px
      }

      @media screen and (min-width: 530px) {
        :host([focus-search]) {
          width: 512px
        }
      }

      @media screen and (min-width: 800px) {
        :host {
          max-width: 300px;
          display: block;
        }
      }

      @media screen and (min-width: 1000px) {
        :host {
          max-width: 512px;
        }
      }

      :host, input {
        width: 100%;
      }

      #results {
        display: block;
        padding: 20px;
        @apply --shadow-elevation-2dp;
        background: var(--theme-100-color, white);
        color: var(--theme-text, black);
      }
    </style>
    <fortifi-search-overlay with-backdrop id="overlay"></fortifi-search-overlay>
    <paper-input no-label-float label="Find products and features" id="search" on-keyup="_query">
      <fort-icon icon="icons:search" slot="prefix"></fort-icon>
    </paper-input>
    <iron-dropdown vertical-align="top" id="results">
      No Results Found
    </iron-dropdown>
  </template>
  <script>
    Polymer(
      {
        is:         'fortifi-search',
        properties: {
          focusSearch: {
            type:               Boolean,
            reflectToAttribute: true
          }
        },
        listeners:  {
          'tap':       "_onTap",
          'mousedown': '_md'
        },
        _query:     function (e)
                    {
                      this.debounce('query', function () {this.runQuery();}, 20);
                    },
        runQuery:   function ()
                    {
                      var query = this.$.search.inputElement.value;
                      if(query.length == 0)
                      {
                        this.$.results.close();
                      }
                      else
                      {
                        this.$.results.innerHTML = "Search Results For: " + query;
                        this.$.results.open();
                      }
                    },
        _md:        function (e)
                    {
                      if(this.$.overlay.opened
                        && e.path.indexOf(this) !== -1 //Clicking search icon should prevent blur
                        && e.path.indexOf(this.$.search.inputElement) == -1) //Selecting within input is valid
                      {
                        e.preventDefault();
                      }
                      this.updateStyles();
                    },
        _onTap:     function (e)
                    {
                      e.preventDefault();
                      if(!this.$.overlay.opened)
                      {
                        this.updateStyles();
                        this.$.overlay._focusedChild = Polymer.dom(this.$.search.inputElement).querySelector('input');
                        this.$.overlay.open();
                      }
                      else
                      {
                        e.stopPropagation();
                      }
                    },
        focus:      function ()
                    {
                      this.$.overlay._focusedChild = Polymer.dom(this.$.search.inputElement).querySelector('input');
                      this.$.overlay.open();
                      this.$.search.focus();
                      this.updateStyles();
                    },
        _onBlur:    function ()
                    {
                      this.$.search.value = "";
                      this.$.search.inputElement.blur();
                      this.$.overlay._focusedChild = null;
                      this.$.overlay.close();
                      this.$.results.close();
                      this.fire('blur');
                      this.updateStyles();
                    },
        _onOverlay: function (e)
                    {
                      this.updateStyles();
                      this.$.overlay.backdropElement.updateStyles(
                        {
                          "--iron-overlay-backdrop": "top: 64px;"
                        }
                      );
                    },
        attached:   function ()
                    {
                      this.listen(this.$.search, 'blur', '_onBlur');
                      this.listen(this.$.overlay, 'iron-overlay-opened', '_onOverlay');
                    }
      }
    );
  </script>
</dom-module>
