<link href="../../polymer/polymer.html" rel="import">
<link rel="import" href="../../paper-input/paper-input.html">
<link rel="import" href="../../paper-styles/shadow.html">
<link rel="import" href="../../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../fort-icon/fort-icon.html">
<link rel="import" href="../../fort-behavior/fort-service-behavior.html">
<link rel="import" href="fortifi-search-overlay.html">

<dom-module id="fortifi-search" attributes="focus-search">
  <template>
    <style>
      :host {
        margin: 0 12px;
        display: none;
        line-height: 12px;
        --paper-input-container-underline: {
          display: none;
        };
        --paper-input-container-underline-focus: {
          display: none;
        };

        --iron-overlay-backdrop: {
          top: 64px;
        };

        --iron-overlay-backdrop-opened: {
          display: none;
        };
      }

      paper-input {
        text-align: left;
        --paper-input-container: {
          background: rgba(255, 255, 255, 0.1);
        };
        border-bottom: 2px solid transparent;
      }

      paper-input:not([focused]) {
        --paper-input-container-label: {
          display: none;
        }
      }

      paper-input[focused] {
        @apply --shadow-elevation-2dp;
        border-bottom-color: var(--accent-400-color);
        background: var(--theme-100-color);
      }

      paper-input[focused] fort-icon {
        color: var(--theme-text-secondary);
      }

      paper-input fort-icon {
        padding: 0;
        margin: 0 12px;
      }

      :host([focus-search]) {
        display: block;
        width: 295px
      }

      @media screen and (min-width: 530px) {
        :host([focus-search]) {
          width: 512px
        }
      }

      @media screen and (min-width: 800px) {
        :host {
          max-width: 300px;
          display: block;
        }
      }

      @media screen and (min-width: 1000px) {
        :host {
          max-width: 512px;
        }
      }

      :host, input {
        width: 100%;
      }

      #results {
        display: block;
        @apply --shadow-elevation-2dp;
        background: var(--theme-100-color, white);
        color: var(--theme-text, black);
      }

      #results span {
        line-height: 22px;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route route="[[route]]" pattern="/:org" data="{{routeData}}"></app-route>

    <fort-resource auto auth url="//[[getServiceHost('apps')]]/fortifi/searchactions/search.json"
                   headers="[[_headers]]" data="{{_search}}"></fort-resource>

    <fortifi-search-overlay with-backdrop id="overlay"></fortifi-search-overlay>
    <paper-input no-label-float label="Find products and features" id="search" on-keyup="_query"
                 value="{{searchQuery}}">
      <fort-icon icon="icons:search" slot="prefix"></fort-icon>
    </paper-input>
    <iron-dropdown vertical-align="top" id="results">
      <fort-list-menu>
        <template is="dom-repeat" items="{{_filterActions(searchQuery,_search.Actions)}}">
          <fort-li>
            <template restamp is="dom-if" if="[[item.Icon]]">
              <fort-icon slot="icon" icon="[[item.Icon]]"></fort-icon>
            </template>
            [[item.Name]]
            <div slot="secondary">[[item.Description]]</div>
          </fort-li>
        </template>
      </fort-list-menu>
    </iron-dropdown>
  </template>
  <script>
    Polymer(
      {
        is:         'fortifi-search',
        properties: {
          searchQuery: {type: String, value: ''},
          focusSearch: {
            type:               Boolean,
            reflectToAttribute: true
          },
          _headers:    {type: Object, computed: '_refreshHeaders(routeData.org)'}
        },

        listeners: {
          'tap':       "_onTap",
          'mousedown': '_md'
        },

        _escapeRegExp: function (str)
                       {
                         return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
                       },

        _filterActions: function (searchQuery, actions)
                        {
                          var filtered = [];
                          if(searchQuery)
                          {
                            var matchWords = searchQuery.replace(/[^a-z0-9\s]+/ig, '').toLowerCase().split(/\s+/);

                            for(var actionIdx in actions)
                            {
                              if(actions.hasOwnProperty(actionIdx))
                              {
                                var action = actions[actionIdx];
                                action.Weight = 0;
                                for(var matchIdx in matchWords)
                                {
                                  if(matchWords.hasOwnProperty(matchIdx))
                                  {
                                    var word = matchWords[matchIdx],
                                      fullTest = new RegExp('\\b' + this._escapeRegExp(word) + '\\b', 'i'),
                                      partialTest = new RegExp('\\b' + this._escapeRegExp(word), 'i');

                                    var tests = [action.Name, action.Description];
                                    Array.prototype.push.apply(tests, action.Tokens || []);

                                    for(var testIdx in tests)
                                    {
                                      if(tests.hasOwnProperty(testIdx))
                                      {
                                        if(fullTest.test(tests[testIdx].replace(/[^a-z0-9\s]+/ig, '')))
                                        {
                                          action.Weight += 2;
                                        }
                                        else if(partialTest.test(tests[testIdx].replace(/[^a-z0-9\s]+/ig, '')))
                                        {
                                          action.Weight += 1;
                                        }
                                      }
                                    }
                                  }
                                }
                                if(action.Weight > 0)
                                {
                                  filtered.push(action);
                                }
                              }
                            }
                          }
                          if(filtered.length <= 0)
                          {
                            filtered.push({Name: 'No Results'});
                          }

                          return filtered.sort(function (a, b) {return a.Weight > b.Weight});
                        },

        _refreshHeaders: function (org)
                         {
                           if(org)
                           {
                             return {'x-fort-org': org};
                           }
                           return undefined;
                         },

        _query:     function (e)
                    {
                      this.debounce('query', function () {this.runQuery();}, 20);
                    },
        runQuery:   function ()
                    {
                      var query = this.searchQuery;
                      if(!query || query.length == 0)
                      {
                        this.$.results.close();
                      }
                      else
                      {
                        this.$.results.open();
                        this.$.results.sizingTarget = null;
                      }
                    },
        _md:        function (e)
                    {
                      if(this.$.overlay.opened
                        && e.path.indexOf(this) !== -1 //Clicking search icon should prevent blur
                        && e.path.indexOf(this.$.search.inputElement) == -1) //Selecting within input is valid
                      {
                        e.preventDefault();
                      }
                      this.updateStyles();
                    },
        _onTap:     function (e)
                    {
                      e.preventDefault();
                      if(!this.$.overlay.opened)
                      {
                        this.updateStyles();
                        this.$.overlay._focusedChild = Polymer.dom(this.$.search.inputElement).querySelector('input');
                        this.$.overlay.open();
                      }
                      else
                      {
                        e.stopPropagation();
                      }
                    },
        focus:      function ()
                    {
                      this.$.overlay._focusedChild = Polymer.dom(this.$.search.inputElement).querySelector('input');
                      this.$.overlay.open();
                      this.$.search.focus();
                      this.updateStyles();
                    },
        _onBlur:    function ()
                    {
                      this.$.search.value = "";
                      this.$.search.inputElement.blur();
                      this.$.overlay._focusedChild = null;
                      this.$.overlay.close();
                      this.$.results.close();
                      this.fire('blur');
                      this.updateStyles();
                    },
        _onOverlay: function (e)
                    {
                      this.updateStyles();
                      this.$.overlay.backdropElement.updateStyles(
                        {
                          "--iron-overlay-backdrop": "top: 64px;"
                        }
                      );
                    },
        attached:   function ()
                    {
                      this.listen(this.$.search, 'blur', '_onBlur');
                      this.listen(this.$.overlay, 'iron-overlay-opened', '_onOverlay');
                    },

        behaviors: [
          Polymer.FortServiceBehavior
        ]
      }
    );
  </script>
</dom-module>
