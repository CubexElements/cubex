<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../paper-dialog/paper-dialog.html">
<link rel="import" href="../../fort-pagelet/fort-pagelet.html">
<link rel="import" href="../../paper-ripple/paper-ripple.html">

<dom-module id="fortifi-link" attributes="mode href hash start-match">
  <template>
    <style>
      :host {
        display: inline;
        position: relative;
      }

      :host a {
        @apply --fortifi-link-style;
      }

      :host([active]) a {
        @apply --fortifi-link-active-style;
      }

      :host(:hover) a {
        @apply --fortifi-link-hover-style;
      }

      paper-ripple {
        @apply --fortifi-link-style;
      }
    </style>

    <iron-location path="{{__path}}" query="{{__query}}" hash="{{__hash}}"></iron-location>

    <template is="dom-if" if="[[_isMode('page',mode)]]">
      <a href="[[href]]">
        <slot></slot>
      </a>
    </template>

    <template is="dom-if" if="[[_isMode('pagelet',mode)]]">
      <a href="#[[hash]]">
        <slot></slot>
      </a>
    </template>

    <template is="dom-if" if="[[_isMode('dialog',mode)]]">
      <paper-dialog id="dialog" with-backdrop>
        <fort-pagelet id="pagelet" auth url="[[href]]"></fort-pagelet>
      </paper-dialog>
      <div on-tap="_tapDialog">
        <slot></slot>
      </div>
    </template>
    <paper-ripple center class="circle"></paper-ripple>
  </template>
  <script>
    Polymer(
      {
        is:         'fortifi-link',
        properties: {
          active:     {type: Boolean, reflectToAttribute: true, value: false},
          startMatch: {type: Boolean, value: false},
          mode:       {type: String, value: 'page'},
          href:       {type: String},
          hash:       {type: String},
          _dlg:       {type: Object},
          _pagelet:   {type: Object}
        },

        observers: ['_activeState(__path,__query,__hash,hash,href,mode,startMatch)'],

        _activeState: function (path, query, urlHash)
                      {
                        if(this.mode == 'page')
                        {
                          var concat = (path ? path : '') + (query ? '?' + query : '') + (urlHash ? '#' + urlHash : '');
                          if(this.href == concat)
                          {
                            this.active = true;
                          }
                          else if(this.href == '#' + urlHash)
                          {
                            this.active = true;
                          }
                          else if(this.href == '?' + query)
                          {
                            this.active = true;
                          }
                          else if(this.href && concat.indexOf(this.href) == 0)
                          {
                            this.active = true;
                          }
                          else
                          {
                            this.active = false;
                          }
                        }
                        else if(this.mode == 'pagelet' && (
                            (urlHash == this.hash)
                            || (this.startMatch && urlHash.indexOf(this.hash) == 0)
                          )
                        )
                        {
                          this.active = true;
                        }
                        else
                        {
                          this.active = false;
                        }
                      },

        _isMode:    function (test, mode)
                    {
                      return test == mode;
                    },
        _tapDialog: function ()
                    {
                      if(!this._pagelet)
                      {
                        this._pagelet = Polymer.dom(this.root).querySelector('#pagelet');
                      }
                      this._pagelet.update();

                      if(!this._dlg)
                      {
                        this._dlg = Polymer.dom(this.root).querySelector('#dialog');
                        document.body.appendChild(this._dlg);
                      }

                      this._dlg.open();
                    }
      }
    );
  </script>
</dom-module>
