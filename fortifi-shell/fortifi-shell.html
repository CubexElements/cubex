<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../app-layout/app-header/app-header.html">
<link rel="import" href="../../paper-styles/typography.html">

<link rel="import" href="../../app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../app-layout/app-drawer-layout/app-drawer-layout.html">

<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../fort-behavior/fort-touch-enabled-behavior.html">
<link rel="import" href="../../app-route/app-location.html">

<link rel="import" href="../../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">

<link rel="import" href="../../iron-media-query/iron-media-query.html">
<link rel="import" href="../../fort-behavior/fort-iterator-behavior.html">

<link rel="import" href="../fortifi-shell-drawer/fortifi-shell-drawer.html">
<link rel="import" href="../fortifi-shell-drawer/fortifi-shell-drawer-panel.html">

<link rel="import" href="../fortifi-theme/styles/primary/fortifi-theme-primary-fortifi-navy.html">
<link rel="import" href="../fortifi-theme/styles/accent/fortifi-theme-accent-fortifi-blue.html">
<link rel="import" href="../fortifi-theme/styles/theme/fortifi-theme-theme-light.html">

<link rel="import" href="../fortifi-pinned-apps/fortifi-pinned-apps.html">
<link rel="import" href="../fortifi-search/fortifi-search.html">
<link rel="import" href="../fortifi-toolbar/fortifi-toolbar.html">
<link rel="import" href="../fortifi-theme/fortifi-theme.html">
<link rel="import" href="../fortifi-theme/fortifi-theme-style.html">
<link rel="import" href="../fortifi-drawer/fortifi-drawer.html">
<link rel="import" href="../fortifi-drawer/fortifi-user-drawer.html">
<link rel="import" href="../fortifi-drawer/fortifi-user-drawer-items.html">
<link rel="import" href="../fortifi-drawer/fortifi-drawer-content.html">
<link rel="import" href="../fortifi-app/fortifi-app-loader.html">
<link rel="import" href="../../iron-pages/iron-pages.html">

<dom-module id="fortifi-shell" attributes="drawer-opened focus-search">
  <template>
    <style>
      :host {
        --app-drawer-width: 320px;
        --fortifi-drawer-offset-top: 64px;
        --fortifi-drawer-peek-width: 56px;
        --fortifi-drawer-width: 256px;
      }

      :host, #flex-toolbar {
        min-width: 320px;
      }

      fortifi-theme::before {
        display: block;
        position: absolute;
        right: 0;
        left: 0;
        height: 236px;
        content: "";
        background: var(--theme-400-color);
        z-index: -1;
      }

      @media screen and (max-width: 320px) {
        :root {
          --app-drawer-width: 256px;
        }
      }

      app-header-layout {
        z-index: 1000;
      }

      app-drawer {
        z-index: 1000;
        top: var(--fortifi-drawer-offset-top);
        --app-drawer-content-container: {
          @apply --primary-700;
          @apply --shadow-elevation-8dp;
          top: -184px;
        };
      }

      #waterfall {
        z-index: 2;
        position: fixed;
        right: 0;
        top: var(--fortifi-drawer-offset-top);
        left: 0;
        width: 100%;
        height: 5px;
        content: "";
        transition: opacity 0.4s;
        pointer-events: none;
        box-shadow: inset 0 5px 3px -3px rgba(0, 0, 0, 0.2);
        will-change: opacity;
        @apply(--app-header-shadow);
      }

      app-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
      }

      app-header, #flex-toolbar {
        height: var(--fortifi-drawer-offset-top);
        line-height: var(--fortifi-drawer-offset-top);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      #flex-toolbar {
        z-index: 1000;
        @apply --layout-horizontal;
        width: 100%;
        transition: 0.2s ease !important;
        transition-property: background-color, transform, left, margin !important;
        @apply --primary-700;
      }

      #flex-toolbar paper-icon-button {
        @apply --primary-700-text-secondary;
      }

      #flex-toolbar paper-icon-button:hover {
        @apply --primary-700-text;
      }

      :host([drawer-opened]) #flex-toolbar {
        @apply --primary-800;
        margin-left: var(--app-drawer-width, 268px) !important;
      }

      #flex-toolbar fortifi-search {
        margin: 12px 0;
      }

      #search-shortcut {
        display: none;
      }

      @media screen and (max-width: 800px) {
        #search-shortcut {
          display: block;
        }
      }

      .spread {
        @apply --layout-flex;
      }

      fortifi-toolbar {
        text-align: right;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: flex-end;
        padding-right: 12px;
      }

      :host([drawer-opened]) fortifi-pinned-apps {
        padding-left: 12px;
      }

      :host([focus-search]) #burger,
      :host([focus-search]) #search-shortcut,
      :host([focus-search]) fortifi-pinned-apps,
      :host([focus-search]) fortifi-toolbar,
      :host([drawer-opened]) #burger,
      :host([drawer-opened]) #search-shortcut,
      :host([drawer-opened]) fortifi-search,
      :host([drawer-opened]) fortifi-toolbar {
        display: none;
      }

      #user-panel-action:hover {
        @apply --text-primary;
      }

      #user-panel-action {
        --fort-icon-color: var(--primary-700-text-color);
        @apply --text-secondary;
        position: relative;
        margin-top: 12px;
        margin-right: 6px;
      }

      #user-panel-action:before,
      #user-panel-action:after {
        content: '';
        display: inline-block;
        border: 5px solid transparent;
        position: absolute;
        top: 16px;
      }

      :host(:not([user-drawer-opened])) #user-panel-action:before {
        border-right-color: var(--primary-700-text-color);
        left: -2px;
      }

      :host([user-drawer-opened]) #user-panel-action:after {
        border-left-color: var(--primary-700-text-color);
        right: -2px;
      }

      #lockUserDrawer {
        position: absolute;
        bottom: 0;
        left: 0;
        color: var(--text-color-secondary);
        cursor: pointer;
      }

      #lockUserDrawer[hidden] {
        display: none;
      }

      #lockSessionAction {
        position: absolute;
        bottom: 0;
        left: 0;
        padding: 16px;
      }

      fort-action[hidden] {
        display: none;
      }

    </style>
    <app-location route="{{route}}"></app-location>
    <iron-media-query query="(min-width: 1000px)" query-matches="{{_peek}}"></iron-media-query>
    <iron-media-query query="(max-width: 375px)" query-matches="{{_narrow}}"></iron-media-query>

    <fortifi-theme primary="fortifi-navy" accent="fortifi-blue" theme="light">
      <app-drawer-layout fullbleed force-narrow>
        <app-drawer id="drawer" opened="{{drawerOpened}}">
          <fortifi-shell-drawer>
            <fortifi-shell-drawer-panel>
              Apps Panel
            </fortifi-shell-drawer-panel>
            <fortifi-shell-drawer-panel>
              Panel 2
            </fortifi-shell-drawer-panel>
          </fortifi-shell-drawer>
        </app-drawer>

        <app-header-layout>
          <app-header fixed>
            <div id="flex-toolbar">
              <div id="burger">
                <paper-icon-button icon="menu" on-tap="_openDrawer"></paper-icon-button>
              </div>
              <fortifi-pinned-apps></fortifi-pinned-apps>
              <div class="spread"></div>
              <fortifi-search id="search" focus-search="[[focusSearch]]"></fortifi-search>
              <div class="spread"></div>
              <div id="search-shortcut">
                <paper-icon-button icon="search" on-tap="_searchFocus"></paper-icon-button>
              </div>
              <fortifi-toolbar id="toolbar"></fortifi-toolbar>
              <div>
                <fort-action hidden="[[_narrow]]" id="user-panel-action" size="23" on-tap="_toggleUserDrawer">
                  icons:chrome-reader-mode
                </fort-action>
              </div>
            </div>
          </app-header>
        </app-header-layout>
        <div id="waterfall"></div>

        <fortifi-drawer id="userDrawer" swipe-open="[[_touchEnabled()]]"
                        max-state="[[_userDrawerMaxState]]"
                        position="right">
          <fortifi-drawer-content>
            <fortifi-user-drawer>
              <iron-pages id="userPages" selected="none" attr-for-selected="data-page-id">
                <div data-page-id="none">nun :(</div>
                <div data-page-id="phone">PHONE Lorem ipsum dolor sit amet, consectetur adipisicing elit. Architecto
                                          autem
                                          consequatur dignissimos doloremque doloribus nihil porro rem sed similique
                                          sit!
                                          Accusamus earum harum hic impedit, maiores quas repellat ut vel?
                </div>
                <div data-page-id="email">EMAIL Lorem ipsum dolor sit amet, consectetur adipisicing elit. Blanditiis
                                          commodi
                                          consequatur deleniti dolorem dolores doloribus in inventore, placeat porro
                                          quisquam quos
                                          repellat sequi sint? Assumenda eum itaque perferendis perspiciatis quisquam!
                </div>
              </iron-pages>
              <fort-action id="lockUserDrawer" on-tap="_lockUserDrawer">
                icons:chrome-reader-mode
              </fort-action>
              <fortifi-user-drawer-items>
                <fort-action on-tap="_openUserDrawerApp" data-page-id="phone">communication:phone</fort-action>
                <fort-action on-tap="_openUserDrawerApp" data-page-id="email">communication:email</fort-action>
                <fort-action id="lockSessionAction">icons:lock</fort-action>
              </fortifi-user-drawer-items>
            </fortifi-user-drawer>
          </fortifi-drawer-content>
          <fortifi-app-loader route="{{route}}"></fortifi-app-loader>
        </fortifi-drawer>

      </app-drawer-layout>

    </fortifi-theme>
  </template>
  <script>
    Polymer(
      {
        is:                   'fortifi-shell',
        behaviors:            [
          Polymer.IronA11yKeysBehavior,
          Polymer.FortTouchEnabledBehavior,
          Polymer.FortIteratorBehavior
        ],
        properties:           {
          drawerOpened: {
            type:               Boolean,
            reflectToAttribute: true
          },
          focusSearch:  {
            type:               Boolean,
            reflectToAttribute: true
          }
        },
        _userDrawerMaxState:  2,
        observers:            [
          '_viewChanged(_peek,_narrow)'
        ],
        keyBindings:          {
          '.': '_toggleDrawer',
          '/': '_launchSearch',
          '?': '_keyboardHelp'
        },
        attached:             function ()
                              {
                                this.keyEventTarget = document.body;
                                document.querySelector(
                                  'body'
                                )
                                        .removeAttribute(
                                          'shellunloaded'
                                        );
                              },
        _keyboardHelp:        function (e)
                              {
                                if(this._isValidKeyPress(e))
                                {
                                  this.$.drawer.close();
                                  this.$.toolbar.openKeyboardHelp();
                                  e.preventDefault();
                                }
                              },
        _viewChanged:         function (peek, narrow)
                              {
                                if(narrow)
                                {
                                  this.$.userDrawer.maxState = 1;
                                }
                                else
                                {
                                  this.$.userDrawer.minState = 0;
                                  this.$.userDrawer.maxState = 2;

                                  if(peek && this.$.userDrawer.state == 0)
                                  {
                                    this.$.userDrawer.setState(1);
                                    this.setAttribute('user-drawer-opened', true);
                                  }
                                }

                                this.updateStyles();
                              },
        _setupClose:          false,
        _blurSearch:          function ()
                              {
                                this.focusSearch = false;
                                this.unlisten(
                                  this.$.search,
                                  'blur',
                                  '_blurSearch'
                                );
                              },
        _searchFocus:         function ()
                              {
                                this.focusSearch = true;
                                this.$.search.focus();
                                this.listen(
                                  this.$.search,
                                  'blur',
                                  '_blurSearch'
                                );
                              },
        _launchSearch:        function (e)
                              {
                                if(this._isValidKeyPress(
                                    e
                                  ))
                                {
                                  this.$.drawer.close();
                                  e.preventDefault();
                                  if(this.$.search.getComputedStyleValue(
                                      'display'
                                    ) == 'block')
                                  {
                                    this.$.search.focus();
                                  }
                                  else
                                  {
                                    this._searchFocus();
                                  }
                                }
                              },
        _prepareDrawer:       function ()
                              {
                                if(!this._setupClose)
                                {
                                  this.$$(
                                    'fortifi-shell-drawer'
                                  )
                                      .addEventListener(
                                        'closeParent',
                                        function (e)
                                        {
                                          drawer.close();
                                        }
                                      );
                                  this._setupClose = true;
                                }
                              },
        _toggleDrawer:        function (e)
                              {
                                this._prepareDrawer();
                                if(this._isValidKeyPress(
                                    e
                                  ))
                                {
                                  var drawer = this.$.drawer;
                                  drawer.toggle();
                                  e.preventDefault();
                                }

                              },
        _openDrawer:          function ()
                              {
                                this._prepareDrawer();
                                this.$.drawer.open();
                              },
        _isValidKeyPress:     function (e)
                              {
                                if(e && e.detail && e.detail.keyboardEvent)
                                {
                                  return e.detail.keyboardEvent.target.tagName == 'BODY';
                                }
                                return true;
                              },
        _toggleUserDrawer:    function ()
                              {
                                var newState = this.$.userDrawer.state ? 0 : (this._userDrawerPrevState ? this._userDrawerPrevState : 1);
                                if(newState == 0)
                                {
                                  this._userDrawerPrevState = this.$.userDrawer.state;
                                  this.$.userDrawer.close();
                                  this.removeAttribute('user-drawer-opened');
                                }
                                else
                                {
                                  this.setAttribute('user-drawer-opened', true);
                                }
                                this.$.userDrawer.setState(newState);
                              },
        _lockUserDrawer:      function ()
                              {
                                this.$.userDrawer.maxState = this.$.userDrawer.state == 2 ? 1 : 2;
                                this.$.userDrawer.setState(
                                  this.$.userDrawer.maxState
                                );
                                this._userDrawerPrevState = this.$.userDrawer.state;
                              },
        _userDrawerPrevState: 0,
        _openUserDrawerApp:   function (e)
                              {
                                this.iterate(
                                  this.root.querySelectorAll('fortifi-user-drawer-items [active]'),
                                  function (e)
                                  {
                                    e.removeAttribute('active');
                                  }
                                );
                                e.currentTarget.setAttribute('active', true);
                                var page = e.currentTarget.getAttribute('data-page-id');
                                if(this.$.userPages.selected == page)
                                {
                                  if(this.$.userDrawer.state == 2)
                                  {
                                    this._userDrawerPrevState = 2;
                                    this.$.userDrawer.maxState = 1;
                                    this.$.userDrawer.setState(this.$.userDrawer.maxState);
                                  }
                                  this.$.userDrawer.toggle();
                                  if(!this.$.userDrawer.isOpen)
                                  {
                                    e.currentTarget.removeAttribute('active');
                                  }
                                }
                                else
                                {
                                  this.$.userPages.select(page);
                                  this.$.userDrawer.open();
                                }
                                if(this.$.userDrawer.isOpen && this._userDrawerPrevState > 0)
                                {
                                  this.$.userDrawer.maxState = this._userDrawerPrevState;
                                  this.$.userDrawer.setState(this.$.userDrawer.maxState);
                                }
                              }
      }
    );
  </script>
</dom-module>
