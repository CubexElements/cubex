<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../fort-dropdown/fort-dropdown.html">
<link rel="import" href="../fort-action/fort-action.html">
<link rel="import" href="../fort-list/fort-list.html">
<link rel="import" href="../fort-icon/fort-icon.html">
<link rel="import" href="../fort-behavior/fort-iterator-behavior.html">
<link rel="import" href="fortifi-notification.html">

<dom-module id="fortifi-notifications" attributes="notifications horizontal-align">
  <template>
    <style>
      :host {
        --paper-spinner-color: var(--accent-400-color);
        --paper-spinner-stroke-width: 3px;
      }

      :host .dropdown-trigger fort-action {
        @apply --primary-700-text-secondary;
        width: 40px;
        height: 40px;
      }

      :host .dropdown-trigger fort-action:hover {
        @apply --primary-700-text;
      }

      :host .dropdown-trigger paper-spinner-lite {
        position: absolute;
        margin: -2px;
      }

      :host([running]) .dropdown-trigger fort-icon {
        transform: scale(0.8);
      }

      :host fort-list.dropdown-content {
        min-width: 350px;
      }

      :host fort-list.dropdown-content fort-action {
        margin-right: -10px;
        margin-left: 10px;
      }

      :host fort-list.dropdown-content fort-li[unread] {
        background-color: var(--primary-700-color);
      }
    </style>

    <fort-dropdown horizontal-align="[[horizontalAlign]]">
      <div class="dropdown-trigger">
        <fort-action>
          <paper-spinner-lite active="[[running]]"></paper-spinner-lite>
          <fort-icon>social:notifications</fort-icon>
        </fort-action>
      </div>
      <fort-list class="dropdown-content" custom>
        <template is="dom-repeat" items="[[notifications]]" sort="__sortNotifications">
          <fort-notification notification="[[item]]"></fort-notification>
        </template>
      </fort-list>
    </fort-dropdown>
  </template>

  <script>
    Polymer(
      {
        is:         'fortifi-notifications',
        properties: {
          running: {type: Boolean, reflectToAttribute: true, computed: '__hasRunning(notifications)'}
        },

        __sortNotifications: function (a, b)
                             {
                               if(a.percent == b.percent)
                               {
                                 if(a.percent == 100)
                                 {
                                   return a.endTime < b.endTime;
                                 }
                                 return a.startTime < b.startTime;
                               }
                               if(a.percent < 100 && b.percent < 100)
                               {
                                 return a.percent < b.percent;
                               }
                               if(a.percent < 100)
                               {
                                 return -1;
                               }
                               if(b.percent < 100)
                               {
                                 return 1;
                               }
                               return a.startTime < b.startTime;
                             },

        __hasRunning: function ()
                      {
                        return !!this.iterate(
                          this.notifications, function (item)
                          {
                            if(item.percentage < 100)
                            {
                              return true;
                            }
                          }
                        );
                      },

        behaviors: [Polymer.FortIteratorBehavior]
      }
    );
  </script>
</dom-module>
