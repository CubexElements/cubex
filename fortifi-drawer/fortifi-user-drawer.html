<link href="../../polymer/polymer.html" rel="import">
<link href="../../iron-flex-layout/iron-flex-layout.html" rel="import">
<link href="fortifi-user-drawer-items.html" rel="import">
<link rel="import" href="../../fort-nudge/fort-nudge.html">
<link rel="import" href="../../fort-action/fort-action.html">
<link rel="import" href="../../fort-behavior/fort-iterator-behavior.html">
<link rel="import" href="../../fort-behavior/fort-element-path-behavior.html">
<link rel="import" href="../../fort-pagelet/fort-pagelet.html">


<dom-module id="fortifi-user-drawer" attributes="drawer">
  <template>
    <style>
      :host {
        --fort-list-style: {
          background: white;
          border-bottom: 1px solid var(--fort-list-border-color, rgba(0, 0, 0, 0.06));
        }
      }

      :host > #contentContainer {
        display: block;
        overflow: hidden;
        padding-right: var(--fortifi-drawer-peek-width);
        width: calc(var(--fortifi-drawer-width) - var(--fortifi-drawer-peek-width) - 2px);
        background: var(--theme-100-color);
      }

      :host ::slotted(fortifi-user-drawer) {
        position: relative;
        min-width: 100%;
        min-height: 100%;
        width: var(--fortifi-drawer-peek-width);
        display: block;
        padding-right: var(--fortifi-drawer-peek-width);
      }

      fortifi-user-drawer-items {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        max-width: var(--fortifi-drawer-peek-width);
        z-index: 1;
        background: var(--primary-800-color);
        color: white
      }

      fortifi-user-drawer-items fort-action {
        padding: 12px
      }

      #lockUserDrawer {
        position: absolute;
        bottom: 0;
        left: 0;
        color: var(--text-color-secondary);
        cursor: pointer;
        padding: 10px;
      }

      #lockUserDrawer[hidden] {
        display: none;
      }

      fort-action#addUserAppAction {
        position: absolute;
        bottom: 0;
        left: 0;
      }
    </style>

    <fortifi-registry user-data="{{_userRegistryData}}"></fortifi-registry>

    <fortifi-user-drawer-items>
      <template is="dom-repeat" items="[[__appGroups(_userRegistryData)]]" as="app">
        <fort-action icon="[[app.icon]]" on-tap="_openUserDrawerApp" gaid$="[[app.vendor_id]]/[[app.id]]"></fort-action>
      </template>
      <fort-action icon="icons:add" id="addUserAppAction" on-tap="_addUserApp"></fort-action>
    </fortifi-user-drawer-items>

    <div id="contentContainer">
      <fort-pagelet auth id="pagelet" url="[[_pageletUrl]]">Loading...</fort-pagelet>
      <fort-action icon="icons:chrome-reader-mode" id="lockUserDrawer" on-tap="_lockUserDrawer"></fort-action>
    </div>
  </template>
  <script>Polymer(
    {
      is:                 'fortifi-user-drawer',
      properties:         {
        drawer:            {type: Object},
        _userRegistryData: {type: Object},
        _pageletUrl:       {type: String}
      },
      attached:           function ()
                          {
                            this.drawer = this._getDrawer();
                          },
      _getDrawer:         function ()
                          {
                            var drawer = null;
                            this.iterate(
                              this.getPath(this), function (parent)
                              {
                                if(parent.tagName == 'FORTIFI-DRAWER')
                                {
                                  drawer = parent;
                                  return true;
                                }
                              }
                            );
                            return drawer;
                          },
      _addUserApp:        function ()
                          {
                            console.error("Adding User App Method Missing");
                          },
      _openUserDrawerApp: function (e)
                          {
                            var page = e.currentTarget.getAttribute('gaid');
                            this._pageletUrl = '//' + this.getServiceHost('apps') + '/' + page;
                            if(e.currentTarget.hasAttribute('active'))
                            {
                              if(this.drawer.state == 2)
                              {
                                this._userDrawerPrevState = 2;
                                this.drawer.setMaxState(1);
                                this.drawer.setState(this.drawer.maxState);
                              }
                              this.drawer.toggle();
                              if(!this.drawer.isOpen)
                              {
                                e.currentTarget.removeAttribute('active');
                              }
                            }
                            else
                            {
                              e.currentTarget.setAttribute('active', true);
                              this.$.pagelet.update();
                              this.drawer.open();
                            }

                            var all = this.shadowRoot.querySelectorAll('fort-action[active]');
                            for(var i in all)
                            {
                              if(all.hasOwnProperty(i) && ((!this.drawer.isOpen) || (all[i] !== e.currentTarget)))
                              {
                                all[i].removeAttribute('active');
                              }
                            }

                            if(this.drawer.isOpen && this._userDrawerPrevState > 0)
                            {
                              this.drawer.setMaxState(this._userDrawerPrevState);
                              this.drawer.setState(this.drawer.maxState);
                            }
                          },
      _lockUserDrawer:    function ()
                          {
                            this.drawer.setMaxState(this.drawer.state == 2 ? 1 : 2);
                            this.drawer.setState(this.drawer.maxState);
                            this._userDrawerPrevState = this.drawer.state;
                          },

      __appGroups: function (userRegistry)
                   {
                     var apps = [];
                     if(userRegistry)
                     {
                       for(var idx in userRegistry.AppSummary)
                       {
                         if(userRegistry.AppSummary.hasOwnProperty(idx))
                         {
                           apps.push(userRegistry.AppSummary[idx]);
                         }
                       }
                     }
                     return apps;
                   },

      behaviors: [
        Polymer.FortElementPathBehavior,
        Polymer.FortIteratorBehavior,
        Polymer.FortServiceBehavior
      ]
    }
  )</script>
</dom-module>
