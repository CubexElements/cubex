<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../app-route/app-route.html">
<link rel="import" href="../../fort-action/fort-action.html">
<link rel="import" href="../../fort-list/fort-li.html">
<link rel="import" href="../../fort-pagelet/fort-pagelet-content.html">
<link rel="import" href="../../fort-behavior/fort-iterator-behavior.html">
<link rel="import" href="../../fort-behavior/fort-service-behavior.html">
<link rel="import" href="../../page-title/page-title.html">
<link rel="import" href="../fortifi-drawer/fortifi-drawer.html">
<link rel="import" href="../fortifi-hash/fortifi-hash.html">
<link rel="import" href="../fortifi-category/fortifi-category.html">
<link rel="import" href="fortifi-app.html">
<link rel="import" href="fortifi-app-title.html">
<link rel="import" href="fortifi-app-header.html">
<link rel="import" href="fortifi-app-menu.html">
<link rel="import" href="fortifi-app-spinner.html">

<dom-module id="fortifi-app-loader" attributes="route vendor">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        position: relative;
        --fortifi-drawer-width: 256px;
      }

      :link, :visited {
        color: var(--accent-400-color);
      }

      :link:hover {
        color: var(--accent-700-color);
      }
    </style>

    <iron-location path="{{__path}}" hash="{{__hash}}"></iron-location>
    <app-route id="route" route="[[route]]" pattern="/:org/:vendor/:app" data="{{routeData}}"
               tail="{{appPath}}" query-params="{{appQuery}}"></app-route>

    <fortifi-registry org-data="{{orgData}}"></fortifi-registry>

    <fortifi-app-definition gaid="[[routeData.vendor]]/[[routeData.app]]"
                            app-data="{{appData}}"></fortifi-app-definition>

    <fort-resource auto auth url="[[_integrationsPath]]" data="{{_integrations}}"
                   headers="[[_appDataHeaders]]" ttl="3600"></fort-resource>
    <fort-resource auto auth url="[[_appDataPath]]" data="{{_pageData}}" xhr="{{_pageXhr}}"
                   headers="[[_appDataHeaders]]"></fort-resource>

    <page-title base-title="Fortifi" page-title="[[pageData.title]]"></page-title>

    <fortifi-app id="app" app-data="[[appData]]" page-data="[[pageData]]"
                 back-path="[[_backPath]]"
                 header-menu="[[_headerMenus]]"
                 header-actions="[[_integrations.HeaderActions]]"
                 page-menu="[[_pageMenus]]"
                 page-actions="[[_pageActions]]"
                 panels="[[_panels]]">
      <fortifi-drawer-content slot="drawer-content" id="appDrawerContent">
        <fortifi-app-menu app-data="[[appData]]"></fortifi-app-menu>
      </fortifi-drawer-content>
      <fortifi-app-spinner slot="spinner" hidden$="[[!_pageSpinnerVisible]]"></fortifi-app-spinner>

      <dom-if restamp if="[[_integration]]">
        <template>
          <fortifi-repath in="[[_integration.Path]]" service="apps" gaid="[[_integration.GlobalAppID]]"
                          out="{{_integrationPath}}"></fortifi-repath>
          <fort-pagelet auto auth url="[[_integrationPath]]"></fort-pagelet>
        </template>
      </dom-if>

      <dom-if restamp if="[[!_integration]]">
        <template id="pageContent"></template>
      </dom-if>
    </fortifi-app>
  </template>

  <script>
    Polymer(
      {
        is:         'fortifi-app-loader',
        properties: {
          _pageSpinnerVisible:    {type: Boolean, value: false},
          _pageletSpinnerVisible: {type: Boolean, value: false},
          _addLoader:             {type: Number, value: 0},
          _loadedPath:            {type: String, value: ''},
          _appDataPath:           {type: String},
          _integrationsPath:      {type: String},
          _appDataHeaders:        {type: Object, computed: '_getHeaders(routeData.org)'},
          _pageXhr:               {type: Object},
          _pageData:              {type: Object},
          _integration:           {type: Object, value: null},
          _backPath:              {
            type:     String,
            computed: '_computedBackPath(routeData.org,appData.GlobalAppID,pageData.backPath,__hash,__path)'
          },

          _headerMenus: {type: Array},
          _pageMenus:   {type: Array},
          _pageActions: {type: Array},
          _panels:      {type: Array},

          appData:  {type: Object, notify: true},
          pageData: {type: Object, notify: true}
        },
        observers:  [
          '_pathChanged(route.path)',
          '_updateData(_pageXhr, _pageData)',
          '_updateIntegration(__hash, _integrations)',
          '_updateHeaderMenu(_integration,_integrations,appData)',
          '_updateSidebar(_integration,_integrations)'
        ],
        attached:   function ()
                    {
                      this.async(this._pathChanged);
                    },

        _getHeaders: function (org)
                     {
                       if(org)
                       {
                         return {'X-FORT-ORG': org};
                       }
                       return {};
                     },

        _computedBackPath: function (org, gaid, path, hash, urlPath)
                           {
                             if(hash)
                             {
                               return urlPath;
                             }
                             if(org && path && path.length > 0)
                             {
                               return '/' + org + '/' + gaid + path;
                             }
                             return '';
                           },
        _updateHeaderMenu: function (integration, integrations, appData)
                           {
                             if(integrations)
                             {
                               var headerMenu = this._integrations.HeaderMenuItems;
                               var newMenu = [];
                               var self = this;
                               if(headerMenu && appData && this.orgData && this.orgData.AppSummary)
                               {
                                 headerMenu = headerMenu.sort(
                                   function (a, b)
                                   {
                                     // if one item is within the current app and one isn't, move the current one up
                                     if((a.Hook.indexOf(a.GlobalAppID) == 0) != (b.Hook.indexOf(b.GlobalAppID) == 0))
                                     {
                                       return (a.GlobalAppID == appData.GlobalAppID) ? -1 : 1;
                                     }
                                     var cA = a.Title, cB = b.Title;
                                     // if not current app, use category
                                     if(a.Hook.indexOf(a.GlobalAppID) !== 0 && b.Hook.indexOf(b.GlobalAppID) !== 0)
                                     {
                                       cA = self.orgData.AppSummary[a.GlobalAppID].category;
                                       cB = self.orgData.AppSummary[b.GlobalAppID].category;
                                     }
                                     // comparisons match, no change
                                     if(cA == cB)
                                     {
                                       return 0;
                                     }
                                     // A is less than B, move A up
                                     return (cA < cB) ? -1 : 1;
                                   }
                                 );

                                 var categoriesAdded = [];
                                 for(var i in headerMenu)
                                 {
                                   if(headerMenu.hasOwnProperty(i))
                                   {
                                     if(headerMenu[i].Hook.indexOf(headerMenu[i].GlobalAppID) === 0)
                                     {
                                       newMenu.push(
                                         {
                                           Title: headerMenu[i].Title,
                                           Path:  '/' + this.routeData.org + '/' + headerMenu[i].GlobalAppID + '/' + headerMenu[i].Path,
                                           Mode:  'page'
                                         }
                                       );
                                     }
                                     else
                                     {
                                       var category = this.orgData.AppSummary[headerMenu[i].GlobalAppID].category;
                                       if(categoriesAdded.indexOf(category) == -1)
                                       {
                                         newMenu.push(
                                           {
                                             Title:    category,
                                             Category: true,
                                             Path:     '/' + this.routeData.org + '/' + headerMenu[i].Hook
                                                       + '#h-' + this._hash32(category),
                                             Hash:     'h-' + this._hash32(category),
                                             Mode:     'page'
                                           }
                                         );
                                         categoriesAdded.push(category);
                                       }
                                     }
                                   }
                                 }
                               }
                             }
                             this._headerMenus = newMenu;
                           },

        _updateSidebar: function (integration, integrations)
                        {
                          var pageMenus = [],
                            pageActions = [],
                            panels = [];

                          if(integrations && this.orgData && this.orgData.AppSummary)
                          {
                            if(integration && this.__hash.substr(0, 2) == 'h-')
                            {
                              var
                                intData = this.orgData.AppSummary[integration.GlobalAppID],
                                category = intData.category,
                                headerMenu = this._integrations.HeaderMenuItems;

                              headerMenu = headerMenu.sort(
                                function (a, b)
                                {
                                  if(a.Title == b.Title)
                                  {
                                    return 0;
                                  }
                                  return (a.Title < b.Title) ? -1 : 1;
                                }
                              );

                              for(var i in headerMenu)
                              {
                                if(headerMenu.hasOwnProperty(i))
                                {
                                  if(this.orgData.AppSummary[headerMenu[i].GlobalAppID].category == category)
                                  {
                                    pageMenus.push(
                                      {
                                        Title:       headerMenu[i].Title,
                                        Description: headerMenu[i].Description,
                                        Hash:        'h-' + this._hash32(category)
                                                     + (pageMenus.length > 0 ? '/' + this._hash32(headerMenu[i].GlobalAppID + '/' + headerMenu[i].ID) : ''),
                                        Href:        '//' + this.getServiceHost('apps') + '/' + headerMenu[i].Path,
                                        Mode:        headerMenu[i].Mode == 'page' ? 'pagelet' : headerMenu[i].Mode
                                      }
                                    );
                                  }
                                }
                              }
                              if(pageMenus.length === 1)
                              {
                                pageMenus = [];
                              }
                            }
                            else
                            {
                              if(this._integrations.PageMenuItems)
                              {
                                var items = this._integrations.PageMenuItems.sort(
                                  function (a, b)
                                  {
                                    if(a.Title == b.Title)
                                    {
                                      return 0;
                                    }
                                    return (a.Title < b.Title) ? -1 : 1;
                                  }
                                );
                                for(var j in items)
                                {
                                  if(items.hasOwnProperty(j))
                                  {
                                    pageMenus.push(
                                      {
                                        Title:       items[j].Title,
                                        Description: items[j].Description,
                                        Hash:        'm-' + this._hash32(items[j].GlobalAppID + '/' + items[j].ID),
                                        Href:        '//' + this.getServiceHost('apps') + '/' + items[j].Path,
                                        Mode:        items[j].Mode
                                      }
                                    );
                                  }
                                }
                              }

                              pageActions = this._integrations.PageActions;
                              panels = this._integrations.Panels;
                            }
                          }
                          this._pageMenus = pageMenus;
                          this._pageActions = pageActions;
                          this._panels = panels;
                        },

        _pathChanged: function ()
                      {
                        if(this.$.route.active)
                        {
                          if(this.route.path !== this._loadedPath)
                          {
                            this._loadedPath = this.route.path;
                            var self = this,
                              path = this.appPath.path.replace(/^\//, ''),
                              fullPath = '/' + this.routeData.vendor + '/' + this.routeData.app + (path ? '/' + path : '');

                            this._addPageSpinner = setTimeout(
                              function () { self._pageSpinnerVisible = true; }, 50
                            );
                            this._integrationsPath = '//' + this.getServiceHost('apps') + '/fortifi/integrations/integrations.json?hook=' + fullPath;
                            this._appDataPath = '//' + this.getServiceHost('apps') + fullPath;
                          }
                        }
                        else
                        {
                          this._integrationsPath = null;
                          this._appDataPath = null;
                          this._loadedPath = null;
                          this.routeData = {};
                          this.pageData = null;
                          this.appData = null;
                        }
                      },

        _updateIntegration: function ()
                            {
                              if(this._integrations && this.orgData && this.orgData.AppSummary)
                              {
                                if(this.__hash)
                                {
                                  var items = null,
                                    hashType = this.__hash.substr(0, 2),
                                    hash = this.__hash.substr(2);
                                  if(hashType == 'm-')
                                  {
                                    items = this._integrations.PageMenuItems;
                                  }
                                  else if(hashType == 'a-')
                                  {
                                    items = this._integrations.PageActions;
                                  }
                                  else if(hashType == 'h-')
                                  {
                                    items = this._integrations.HeaderMenuItems;
                                  }
                                  if(items)
                                  {
                                    items = items.sort(
                                      function (a, b)
                                      {
                                        if(a.Title == b.Title)
                                        {
                                          return 0;
                                        }
                                        return (a.Title < b.Title) ? -1 : 1;
                                      }
                                    );
                                    for(var i in items)
                                    {
                                      if(items.hasOwnProperty(i))
                                      {
                                        var catHash = this._hash32(this.orgData.AppSummary[items[i].GlobalAppID].category),
                                          gaidHash = this._hash32(items[i].GlobalAppID + '/' + items[i].ID);
                                        if(
                                          (catHash + '/' + gaidHash == hash)
                                          || (catHash == hash)
                                          || (gaidHash == hash)
                                        )
                                        {
                                          this._integration = items[i];
                                          this.$.app._resetLayout();
                                          return;
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                              this._integration = null;
                              this.$.app._resetLayout();
                            },

        _updateData: function ()
                     {
                       var frag = document.createRange().createContextualFragment(this._pageData || ''),
                         imports = frag.querySelectorAll('link[rel="import"]'),
                         fortHeaderRegex = /x-fort-([a-z\-]+): (.*)[\n\r]*/g,
                         headers = {};

                       if(this._pageXhr)
                       {
                         var fn = function (_, v) { return v.toUpperCase(); };
                         while(matches = fortHeaderRegex.exec(this._pageXhr.getAllResponseHeaders()))
                         {
                           headers[matches[1].replace(/-([a-z])/, fn)] = matches[2];
                         }
                       }

                       for(var idx in imports)
                       {
                         if(imports.hasOwnProperty(idx))
                         {
                           this.importHref(imports[idx].getAttribute('href'));
                           frag.removeChild(imports[idx]);
                         }
                       }

                       if(this._addPageSpinner)
                       {
                         clearTimeout(this._addPageSpinner);
                       }
                       this._pageSpinnerVisible = false;

                       // modify the dom-if template
                       this.$.pageContent._content = frag;
                       // rebuild dom-if template instance
                       this.$.pageContent.parentNode._teardownInstance();
                       this.$.pageContent.parentNode._render();

                       this.pageData = headers;
                     },

        behaviors: [
          Polymer.FortIteratorBehavior,
          Polymer.FortServiceBehavior,
          Polymer.FortHashBehavior
        ]
      }
    )
  </script>
</dom-module>
