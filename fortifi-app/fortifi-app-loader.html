<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../fortifi-drawer/fortifi-drawer.html">
<link rel="import" href="../../fort-loader/fort-loader.html">
<link rel="import" href="../../fort-action/fort-action.html">
<link rel="import" href="../../fort-list/fort-li.html">
<link rel="import" href="fortifi-app.html">
<link rel="import" href="fortifi-app-title.html">
<link rel="import" href="fortifi-app-header.html">
<link rel="import" href="fortifi-app-menu.html">
<link rel="import" href="../../fort-pagelet/fort-pagelet-content.html">
<link rel="import" href="../../app-route/app-route.html">
<link rel="import" href="../../fort-behavior/fort-iterator-behavior.html">
<link rel="import" href="../../fort-behavior/fort-service-behavior.html">

<dom-module id="fortifi-app-loader" attributes="route vendor">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        position: relative;
        --fortifi-drawer-width: 256px;
      }
    </style>

    <iron-location hash="{{__hash}}"></iron-location>
    <app-route id="route" route="[[route]]" pattern="/:org/:vendor/:app" data="{{routeData}}"
               tail="{{appPath}}" query-params="{{appQuery}}"></app-route>

    <fortifi-app-definition gaid="[[routeData.vendor]]/[[routeData.app]]"
                            app-data="{{appData}}"></fortifi-app-definition>

    <fort-resource auto auth url="[[_integrationsPath]]" data="{{_integrations}}"
                   headers="[[_appDataHeaders]]"></fort-resource>
    <fort-resource auto auth url="[[_appDataPath]]" data="{{_pageData}}" xhr="{{_pageXhr}}"
                   headers="[[_appDataHeaders]]"></fort-resource>

    <fortifi-app id="app" app-data="[[appData]]" page-data="[[pageData]]" integrations="[[_integrations]]">
      <fortifi-drawer-content slot="drawer-content" id="appDrawerContent">
        <fortifi-app-menu app-data="[[appData]]"></fortifi-app-menu>
      </fortifi-drawer-content>
      <fort-loader hidden$="[[!_loaderVisible]]"></fort-loader>

      <fort-pagelet auto auth url="[[_pageletPath]]"></fort-pagelet>

      <dom-if restamp if="[[!_pageletPath]]">
        <template id="pageContent"></template>
      </dom-if>
    </fortifi-app>
  </template>
  <script>
    Polymer(
      {
        is:         'fortifi-app-loader',
        properties: {
          _loaderVisible:    {type: Boolean, value: false},
          _addLoader:        {type: Number, value: 0},
          _loadedPath:       {type: String, value: ''},
          _appDataPath:      {type: String},
          _integrationsPath: {type: String},
          _appDataHeaders:   {type: Object, computed: '_getHeaders(routeData.org)'},
          _pageXhr:          {type: Object},
          _pageData:         {type: Object},
          appData:           {type: Object, notify: true},
          pageData:          {type: Object, notify: true}
        },
        observers:  [
          '_pathChanged(route.path)',
          '_updateData(_pageXhr, _pageData)',
          '_updateWithHash(__hash, _integrations)'
        ],
        attached:   function ()
                    {
                      this.async(this._pathChanged);
                    },

        _getHeaders: function (org)
                     {
                       if(org)
                       {
                         return {'X-FORT-ORG': org};
                       }
                       return {};
                     },

        _pathChanged: function ()
                      {
                        if(this.$.route.active)
                        {
                          if(this.route.path !== this._loadedPath)
                          {
                            this._loadedPath = this.route.path;
                            var self = this,
                              vendor = this.routeData.vendor,
                              app = this.routeData.app,
                              path = this.appPath.path.replace(/^\//, ''),
                              fullPath = vendor + '/' + app + (path ? '/' + path : '');

                            this._addLoader = setTimeout(
                              function () { self._loaderVisible = true; }, 50
                            );
                            this._integrationsPath = '//' + this.getServiceHost('apps') + '/fortifi/integrations/integrations.json?hook=/' + fullPath;
                            this._appDataPath = '//' + this.getServiceHost('apps') + '/' + fullPath;
                          }
                        }
                        else
                        {
                          this._integrationsPath = null;
                          this._appDataPath = null;
                          this._loadedPath = null;
                          this.routeData = {};
                          this.pageData = null;
                          this.appData = null;
                        }
                      },

        _updateWithHash: function ()
                         {
                           if(this.__hash && this._integrations)
                           {
                             var items = null;
                             if(this.__hash.substr(0, 2) == 'm-')
                             {
                               items = this._integrations.PageMenuItems;
                             }
                             else if(this.__hash.substr(0, 2) == 'a-')
                             {
                               items = this._integrations.PageActions;
                             }
                             if(items)
                             {
                               for(var i in items)
                               {
                                 if(items.hasOwnProperty(i))
                                 {
                                   if(items[i].ID == this.__hash.substr(2))
                                   {
                                     this._pageletPath = '//' + this.getServiceHost('apps') + items[i].Path;
                                     return;
                                   }
                                 }
                               }
                             }
                           }
                           this._pageletPath = '';
                         },

        _updateData: function ()
                     {
                       var frag = document.createRange().createContextualFragment(this._pageData || ''),
                         imports = frag.querySelectorAll('link[rel="import"]'),
                         fortHeaderRegex = /x-fort-([a-z\-]+): (.*)[\n\r]*/g,
                         headers = {};

                       if(this._pageXhr)
                       {
                         var fn = function (_, v) { return v.toUpperCase(); };
                         while(matches = fortHeaderRegex.exec(this._pageXhr.getAllResponseHeaders()))
                         {
                           headers[matches[1].replace(/-([a-z])/, fn)] = matches[2];
                         }
                       }

                       for(var idx in imports)
                       {
                         if(imports.hasOwnProperty(idx))
                         {
                           this.importHref(imports[idx].getAttribute('href'));
                           frag.removeChild(imports[idx]);
                         }
                       }

                       if(this._addLoader)
                       {
                         clearTimeout(this._addLoader);
                       }
                       this._loaderVisible = false;

                       // modify the dom-if template
                       this.$.pageContent._content = frag;
                       // rebuild dom-if template instance
                       this.$.pageContent.parentNode._teardownInstance();
                       this.$.pageContent.parentNode._render();

                       this.pageData = headers;
                     },

        behaviors: [
          Polymer.FortIteratorBehavior,
          Polymer.FortServiceBehavior
        ]
      }
    )
  </script>
</dom-module>
