<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../fortifi-drawer/fortifi-drawer.html">
<link rel="import" href="../../fort-loader/fort-loader.html">
<link rel="import" href="../../fort-action/fort-action.html">
<link rel="import" href="../../fort-list/fort-li.html">
<link rel="import" href="fortifi-app.html">
<link rel="import" href="fortifi-app-title.html">
<link rel="import" href="fortifi-app-header.html">
<link rel="import" href="fortifi-app-menu.html">
<link rel="import" href="../../fort-pagelet/fort-pagelet-content.html">
<link rel="import" href="../../app-route/app-route.html">
<link rel="import" href="../../fort-behavior/fort-iterator-behavior.html">
<link rel="import" href="../../fort-behavior/fort-service-behavior.html">

<dom-module id="fortifi-app-loader" attributes="route vendor app path app-data">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        position: relative;
      }
    </style>

    <app-route id="route" route="[[route]]" pattern="/:org/:vendor/:app" data="{{routeData}}"
               tail="{{appPath}}" query-params="{{appQuery}}"></app-route>
    <fortifi-app id="app" vendor="[[routeData.vendor]]" app="[[routeData.app]]" app-data="{{appData}}">
      <fortifi-drawer-content slot="drawer-content" id="appDrawerContent">
        <fortifi-app-menu app-data="[[appData]]"></fortifi-app-menu>
      </fortifi-drawer-content>
      <fort-loader></fort-loader>
    </fortifi-app>
  </template>
  <script>
    Polymer(
      {
        is:           'fortifi-app-loader',
        properties:   {
          appData:     {type: Object, notify: true},
          _addLoader:  {type: Number, value: 0},
          _loadedPath: {type: String, value: ''}
        },
        observers:    [
          '_pathChanged(route.path)'
        ],
        attached:     function ()
                      {
                        this.async(this._pathChanged);
                      },
        _pathChanged: function ()
                      {
                        if(this.$.route.active && this.route.path !== this._loadedPath)
                        {
                          this._loadedPath = this.route.path;
                          var vendor = this.routeData.vendor,
                            app = this.routeData.app,
                            path = this.appPath.path.replace(/^\//, '');
                          var self = this, oReq = new XMLHttpRequest(), appNode = Polymer.dom(this.$.app);
                          this._addLoader = setTimeout(
                            function () { appNode.appendChild(document.createElement('fort-loader')); }, 50
                          );
                          oReq.addEventListener(
                            "load", function ()
                            {
                              if(this.status == '200')
                              {
                                self._setContent(this.responseText);
                              }
                            }
                          );
                          oReq.withCredentials = true;
                          oReq.open(
                            'GET',
                            '//' + this.getServiceHost('apps') + '/' + vendor + '/' + app + (path ? '/' + path : '')
                          );
                          oReq.setRequestHeader('X-FORT-ORG', this.routeData.org);
                          oReq.send();
                        }
                        else
                        {
                          this._setContent('');
                          this.routeData = {};
                          this.appData = {};
                          this._loadedPath = null;
                        }
                      },
        _setContent:  function (content)
                      {
                        var frag = document.createRange().createContextualFragment(content),
                          imports = frag.querySelectorAll('link[rel="import"]'),
                          toLoad = imports.length,
                          loaded = 0;

                        if(toLoad > 0)
                        {
                          for(var idx in imports)
                          {
                            if(imports.hasOwnProperty(idx))
                            {
                              this.importHref(imports[idx].getAttribute('href'), completeLoad);
                              frag.removeChild(imports[idx]);
                            }
                          }
                        }
                        else
                        {
                          completeLoad.apply(this);
                        }

                        function completeLoad()
                        {
                          loaded++;
                          if(loaded >= toLoad)
                          {
                            if(this._addLoader)
                            {
                              clearTimeout(this._addLoader);
                            }

                            var appNode = Polymer.dom(this.$.app);
                            this.iterate(
                              appNode.getEffectiveChildNodes(),
                              function (node)
                              {
                                if(node.nodeType == 3 || node.id !== 'appDrawerContent')
                                {
                                  appNode.removeChild(node);
                                }
                              }
                            );
                            appNode.appendChild(frag);
                          }
                        }
                      },

        behaviors: [
          Polymer.FortIteratorBehavior,
          Polymer.FortServiceBehavior
        ]
      }
    )
  </script>
</dom-module>
