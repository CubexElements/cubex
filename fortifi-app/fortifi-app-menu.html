<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../fort-list/fort-list.html">
<link rel="import" href="../../fort-icon/fort-icon.html">
<link rel="import" href="../../fort-behavior/fort-element-path-behavior.html">
<link rel="import" href="../../fort-behavior/fort-iterator-behavior.html">
<link rel="import" href="../../fort-behavior/fort-i18n-behavior.html">
<link rel="import" href="../../app-route/app-location.html">
<link rel="import" href="../../app-route/app-route.html">

<dom-module id="fortifi-app-menu" attributes="app-data">
  <template strip-whitespace>
    <style>
      :host {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        position: absolute;
        display: flex;
        flex-direction: column;
        align-content: flex-start;
      }

      :host fortifi-app-title {
        align-self: flex-start;
        min-height: 64px;
      }

      .flex {
        flex: auto;
      }

      :host {
        --fort-list-items-container: {
          width: 100%;
        }
      }

      :host fort-list {
        width: 100%;
        display: flex;
        overflow-y: scroll;
        overflow-x: hidden;
        min-height: 100px;
      }

      :host fort-li {
        cursor: pointer;

        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;

        width: 100%;
      }

      :host fort-li {
        color: var(--text-color-secondary);
      }

      :host fort-li:hover {
        background: var(--theme-500-color);
      }

      :host fort-li[active] {
        background: var(--accent-100-color) !important;
        color: var(--accent-700-color);
      }

      :host fort-li[active]:before {
        content: ' ';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 5px;
        background: var(--accent-700-color);
      }

      #configure {
        align-self: flex-end;
      }

      #configure {
        display: none;
        background: var(--theme-500-color);
      }

      #configure:hover {
        background: var(--theme-600-color);
        color: var(--accent-700-color);
      }

      #configure[shown] {
        display: block;
      }

      #toggler {
        @apply --accent-400;
      }

      #toggler:hover {
        @apply --accent-700;
      }

      fort-icon {
        position: relative;
        min-width: 24px;
        width: 24px;
        margin-right: 15px;
      }

      #toggler fort-icon:before,
      #toggler fort-icon:after {
        content: '';
        display: inline-block;
        border: 5px solid transparent;
        position: absolute;
        top: 8px;
      }

      #toggler[drawer-open] fort-icon:before {
        border-right-color: var(--accent-400-text-color);
        left: -12px;
      }

      #toggler:not([drawer-open]) fort-icon:after {
        border-left-color: var(--accent-400-text-color);
        right: -12px;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route route="[[route]]" pattern="/:org" data="{{routeData}}"></app-route>

    <template restamp is="dom-if" if="[[appData.Name]]">
      <fortifi-app-title icon="[[appData.Icon]]" title="[[i18n('app_name')]]" vendor="[[appData.Vendor]]"
                         trusted-vendor="[[appData.TrustedVendor]]"></fortifi-app-title>
    </template>

    <template restamp is="dom-if" if="[[appData.Navigation.length]]">
      <fort-list>
        <template is="dom-repeat" items="[[appData.Navigation]]">
          <fort-li href$="/[[routeData.org]]/[[appData.GlobalAppID]]/[[item.Path]]">
            <fort-icon slot="icon" icon="[[item.Icon]]"></fort-icon>
            [[i18n_c4t('nav_', item.ID, '_name')]]
            <paper-ripple></paper-ripple>
          </fort-li>
        </template>
      </fort-list>
    </template>

    <div class="flex"></div>

    <fort-li href$="/[[routeData.org]]/[[appData.GlobalAppID]]/[[configPath]]" id="configure" shown$="[[configPath]]"
             primary="[[i18n('configure')]]">
      <fort-icon slot="icon" icon="icons:settings"></fort-icon>
      [[i18n('configure')]]
      <paper-ripple></paper-ripple>
    </fort-li>

    <fort-li id="toggler" on-tap="_toggleDrawer" drawer-open$="[[_drawerOpen]]">
      <fort-icon icon="icons:chrome-reader-mode" slot="icon"></fort-icon>
      <template is="dom-if" if="[[_drawerOpen]]">
        [[i18n('collapse')]]
      </template>
      <template is="dom-if" if="[[!_drawerOpen]]">
        [[i18n('keep_out')]]
      </template>
      <paper-ripple></paper-ripple>
    </fort-li>
  </template>
  <script>
    Polymer(
      {
        is: 'fortifi-app-menu',

        properties: {
          configPath:  {type: String, computed: '_calculateConfigure(appData,routeData)'},
          appData:     {type: Object, notify: true, observer: '_resetResources'},
          resources:   {type: Object},
          _drawerOpen: {type: Boolean, value: false}
        },
        attached:   function ()
                    {
                      this._resetResources();
                      this._refreshDrawerState();
                      document.addEventListener('fortifi-drawer-state-changed', this._refreshDrawerState.bind(this));
                    },

        _getApp:             function ()
                             {
                               var app = null;
                               this.iterate(
                                 this.getPath(this), function (parent)
                                 {
                                   if(parent.tagName == 'FORTIFI-APP')
                                   {
                                     app = parent;
                                     return false;
                                   }
                                 }
                               );
                               return app;
                             },
        _setDrawerState:     function (state)
                             {
                               this._getApp().setDrawerState(state);
                             },
        _toggleDrawer:       function ()
                             {
                               var app = this._getApp();
                               if(app.narrow)
                               {
                                 app.drawer.toggle();
                               }
                               else if(app.drawer.state == 2)
                               {
                                 this._setDrawerState(1);
                               }
                               else
                               {
                                 this._setDrawerState(2);
                               }
                               this._refreshDrawerState();
                             },
        _refreshDrawerState: function ()
                             {
                               this._drawerOpen = this._getApp().drawer.state == 2;
                             },
        _calculateConfigure: function ()
                             {
                               if(this.routeData && this.appData)
                               {
                                 if(this.appData.Config && this.appData.Config.length)
                                 {
                                   return '_configure';
                                 }
                                 else if(this.appData.AdvancedConfigPath && this.appData.AdvancedConfigPath.length)
                                 {
                                   return this.appData.AdvancedConfigPath.replace(/^\//, '');
                                 }
                               }
                               return null;
                             },
        _resetResources:     function ()
                             {
                               var self = this,
                                 res = {
                                   "en": {
                                     "configure": "Configure",
                                     "collapse":  "Collapse Menu",
                                     "keep_out":  "Keep Menu Out"
                                   },
                                   "fr": {
                                     "configure": "Configurer",
                                     "collapse":  "RÃ©duire Menu",
                                     "keep_out":  "Gardez Menu Out"
                                   }
                                 };

                               if(this.appData && this.appData.Name)
                               {
                                 res = this.hydrateResources(res, 'app_name', this.appData.Name);
                                 this.iterate(
                                   this.appData.Navigation, function (nav)
                                   {
                                     res = self.hydrateResources(res, 'nav_' + nav.ID + '_name', nav.Name);
                                     res = self.hydrateResources(
                                       res,
                                       'nav_' + nav.ID + '_description',
                                       nav.Description
                                     );
                                   }
                                 );

                                 this.resources = res;
                               }
                               else
                               {
                                 this.async(function () { this.resources = res; });
                               }
                             },

        behaviors: [
          Polymer.FortElementPathBehavior,
          Polymer.FortIteratorBehavior,
          Polymer.FortI18nBehavior
        ]
      }
    )
  </script>
</dom-module>
