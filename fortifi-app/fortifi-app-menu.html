<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../fort-list/fort-list.html">
<link rel="import" href="../../fort-icon/fort-icon.html">
<link rel="import" href="../../fort-behavior/fort-element-path-behavior.html">
<link rel="import" href="../../fort-behavior/fort-iterator-behavior.html">
<link rel="import" href="../../fort-behavior/fort-i18n-behavior.html">
<link rel="import" href="../../app-route/app-location.html">
<link rel="import" href="../../app-route/app-route.html">

<dom-module id="fortifi-app-menu" attributes="app-data">
  <template strip-whitespace>
    <style>
      :host {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        position: absolute;
        display: flex;
        flex-direction: column;
        align-content: flex-start;
      }

      :host fortifi-app-title,
      :host ::content fortifi-app-title {
        align-self: flex-start;
        min-height: 64px;
      }

      .flex {
        flex: auto;
      }

      :host {
        --fort-list-items-container: {
          width: 100%;
        }
      }

      :host fort-list {
        width: 100%;
        display: flex;
        overflow-y: scroll;
        overflow-x: hidden;
        min-height: 100px;
      }

      :host ::content fort-li,
      .accent,
      :host fort-li {
        cursor: pointer;

        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;

        width: 100%;
      }

      :host ::content fort-li,
      :host fort-li {
        color: var(--text-color-secondary);
      }

      :host ::content fort-li:hover {
        background: var(--theme-500-color);
      }

      :host ::content fort-li:active,
      :host ::content fort-li[active],
      :host fort-li:active,
      :host fort-li[active] {
        background: var(--accent-100-color) !important;
        color: var(--accent-700-color);
      }

      :host ::content fort-li:active:before,
      :host ::content fort-li[active]:before,
      :host fort-li:active:before,
      :host fort-li[active]:before {
        content: ' ';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 5px;
        background: var(--accent-700-color);
      }

      #configure, .accent {
        align-self: flex-end;
      }

      #configure {
        display: none;
        background: var(--theme-500-color);
      }

      #configure:hover {
        background: var(--theme-600-color);
        color: var(--accent-700-color);
      }

      #configure[shown] {
        display: block;
      }

      .accent {
        display: none;
        @apply --accent-400;
      }

      .accent:hover {
        @apply --accent-700;
      }

      .accent fort-icon {
        position: relative;
        margin-right: -9px;
      }

      .accent fort-icon:before,
      .accent fort-icon:after {
        content: '';
        display: inline-block;
        border: 5px solid transparent;
        position: absolute;
        top: 8px;
      }

      #collapse fort-icon:before {
        border-right-color: var(--accent-400-text-color);
        left: -12px;
      }

      #expand fort-icon:after {
        border-left-color: var(--accent-400-text-color);
        right: -12px;
      }

      :host-context(fortifi-app[narrow]):host-context(fortifi-drawer#appDrawer[is-open]) #collapse,
      :host-context(fortifi-app:not([narrow])):host-context(fortifi-drawer#appDrawer[state="2"]) #collapse {
        display: block;
      }

      :host-context(fortifi-app[narrow]):host-context(fortifi-drawer#appDrawer:not([is-open])) #expand,
      :host-context(fortifi-app:not([narrow])):host-context(fortifi-drawer#appDrawer[state="1"]) #expand,
      :host-context(fortifi-app:not([narrow])):host-context(fortifi-drawer#appDrawer[state="0"]) #expand {
        display: block;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/:org" data="{{routeData}}"></app-route>

    <template restamp is="dom-if" if="{{appData.Name}}">
      <fortifi-app-title icon="{{appData.Icon}}" title="{{i18n('app_name')}}" vendor="{{appData.Vendor}}"
                         trusted-vendor="{{appData.TrustedVendor}}"></fortifi-app-title>
    </template>

    <template restamp is="dom-if" if="{{appData.Navigation.length}}">
      <fort-list>
        <template is="dom-repeat" items="{{appData.Navigation}}">
          <fort-li href$="/{{routeData.org}}/{{appData.GlobalAppID}}/{{item.Path}}"
                   primary="{{i18n_c4t('nav_', item.ID, '_name')}}">
            <fort-icon icon="{{item.Icon}}" item-icon></fort-icon>
          </fort-li>
        </template>
      </fort-list>
    </template>

    <div class="flex"></div>

    <fort-li href$="[[configPath]]" id="configure" shown$="[[configPath]]" primary="{{i18n('configure')}}">
      <fort-icon icon="icons:settings" item-icon></fort-icon>
    </fort-li>

    <fort-li class="accent" id="collapse" on-tap="_collapseDrawer" primary="{{i18n('collapse')}}">
      <fort-icon icon="icons:chrome-reader-mode" item-icon></fort-icon>
    </fort-li>
    <fort-li class="accent" id="expand" on-tap="_expandDrawer" primary="{{i18n('keep_out')}}">
      <fort-icon icon="icons:chrome-reader-mode" item-icon></fort-icon>
    </fort-li>
  </template>
  <script>
    Polymer(
      {
        is: 'fortifi-app-menu',

        properties: {
          configPath: {type: String, computed: '_calculateConfigure(appData)'},
          appData:    {type: Object, notify: true, observer: '_resetResources'},
          resources:  {type: Object, value: this._resetResources}
        },

        _getApp:             function ()
                             {
                               var app = null;
                               this.iterate(
                                 this.getPath(this), function (parent)
                                 {
                                   if(parent.tagName == 'FORTIFI-APP')
                                   {
                                     app = parent;
                                     return false;
                                   }
                                 }
                               );
                               return app;
                             },
        _setDrawerState:     function (state)
                             {
                               this._getApp().setDrawerState(state);
                             },
        _collapseDrawer:     function ()
                             {
                               if(this._getApp().narrow)
                               {
                                 this._getApp().drawer.close();
                               }
                               else
                               {
                                 this._setDrawerState(1);
                               }
                             },
        _expandDrawer:       function ()
                             {
                               if(this._getApp().narrow)
                               {
                                 this._getApp().drawer.open();
                               }
                               else
                               {
                                 this._setDrawerState(2);
                               }
                             },
        _calculateConfigure: function ()
                             {
                               if(this.appData.Config && this.appData.Config.length)
                               {
                                 return '/' + this.routeData.org + '/' + this.appData.GlobalAppID
                                   + '/_configure';
                               }
                               else if(this.appData.AdvancedConfigPath && this.appData.AdvancedConfigPath.length)
                               {
                                 return '/' + this.routeData.org + '/' + this.appData.GlobalAppID
                                   + '/' + this.appData.AdvancedConfigPath.replace(/^\//, '');
                               }
                               return null;
                             },
        _resetResources:     function ()
                             {
                               var self = this,
                                 res = {
                                   "en": {
                                     "configure": "Configure",
                                     "collapse":  "Collapse Menu",
                                     "keep_out":  "Keep Menu Out"
                                   },
                                   "fr": {
                                     "configure": "Configurer",
                                     "collapse":  "RÃ©duire Menu",
                                     "keep_out":  "Gardez Menu Out"
                                   }
                                 };

                               if(this.appData.Name)
                               {
                                 res = this.hydrateResources(res, 'app_name', this.appData.Name);
                                 this.iterate(
                                   this.appData.Navigation, function (nav)
                                   {
                                     res = self.hydrateResources(res, 'nav_' + nav.ID + '_name', nav.Name);
                                     res = self.hydrateResources(
                                       res,
                                       'nav_' + nav.ID + '_description',
                                       nav.Description
                                     );
                                   }
                                 );

                                 this.resources = res;
                               }
                               else
                               {
                                 this.async(function () { this.resources = res; });
                               }
                             },

        behaviors: [
          Polymer.FortElementPathBehavior,
          Polymer.FortIteratorBehavior,
          Polymer.FortI18nBehavior
        ]
      }
    )
  </script>
</dom-module>
