<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../fortifi-drawer/fortifi-drawer.html">
<link rel="import" href="../fortifi-drawer/fortifi-drawer-content.html">
<link rel="import" href="../fortifi-breadcrumb/fortifi-breadcrumb.html">
<link rel="import" href="../fortifi-app/fortifi-app-definition.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../iron-media-query/iron-media-query.html">
<link rel="import" href="../../fort-behavior/fort-touch-enabled-behavior.html">
<link rel="import" href="../../fort-behavior/fort-service-behavior.html">
<link rel="import" href="../../app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../app-layout/app-header/app-header.html">
<link rel="import" href="../../app-layout/app-toolbar/app-toolbar.html">


<!--
An element providing a solution to no problem in particular.

Example:

    <fortifi-app>
    </fortifi-app>


@demo demo/index.html
@hero hero.svg
-->

<dom-module id="fortifi-app" attributes="vendor app app-data">
  <template>
    <style>
      :host {
        display: block;
        --fortifi-drawer-peek-width: 56px;
      }

      fortifi-app-header {
        border-top-left-radius: 3px;
        border-top-right-radius: 3px;
      }

      app-header-layout {
        padding-bottom: 24px;
        margin: 0 24px;
        min-width: 100px;
      }

      .app-container {
        border-bottom-left-radius: 3px;
        border-bottom-right-radius: 3px;
        @apply --theme-600;
        overflow: hidden;
      }

      .app-content {
        margin: 40px;
      }

      fortifi-breadcrumb {
        margin: 0 -24px;
        @apply --theme-400;
      }

      :host app-toolbar {
        padding: 0;
      }

      :host app-header {
        margin-top: var(--fortifi-drawer-offset-top, 0);
        transition: left ease 0.2s, right ease 0.2s !important;
      }

      :host([drawer-disabled]) {
        --fortifi-drawer-peek-width: 0;
        --fortifi-drawer-width: 0;
      }
    </style>

    <iron-media-query query="(max-width: 375px)" query-matches="{{narrow}}"></iron-media-query>
    <iron-media-query query="(min-width: 1000px)" query-matches="{{_peek}}"></iron-media-query>
    <iron-media-query query="(min-width: 1300px)" query-matches="{{_lock}}"></iron-media-query>

    <fortifi-app-definition vendor="[[vendor]]" app="[[app]]" app-data="{{appData}}"></fortifi-app-definition>

    <fortifi-drawer id="appDrawer" hover-popout swipe-open position="left">
      <slot slot="drawer-content" name="drawer-content"></slot>
      <app-header-layout>
        <app-header id="ah" slot="header" condenses reveals effects="waterfall">
          <fortifi-breadcrumb></fortifi-breadcrumb>
          <app-toolbar sticky>
            <slot name="app-header"></slot>
          </app-toolbar>
        </app-header>
        <div class="app-container">
          <div class="app-content">
            <slot></slot>
          </div>
        </div>
      </app-header-layout>
    </fortifi-drawer>

  </template>
  <script>
    Polymer(
      {
        is:              'fortifi-app',
        behaviors:       [Polymer.FortTouchEnabledBehavior, Polymer.FortServiceBehavior],
        properties:      {
          narrow:         {type: Boolean, value: true, reflectToAttribute: true, observer: '_updateMaxState'},
          vendor:         {type: String},
          app:            {type: String},
          appData:        {type: Object, notify: true},
          drawerDisabled: {
            type:               Boolean,
            value:              false,
            reflectToAttribute: true
          },
          _lock:          {type: Boolean, value: false},
          _peek:          {type: Boolean, value: false}
        },
        observers:       [
          '_viewChanged(_lock,_peek,narrow)',
          '_updateDrawer(appData)'
        ],
        _updateDrawer:   function (appData)
                         {
                           this.drawerDisabled = !(appData && appData.Navigation && appData.Navigation.length);
                         },
        ready:           function ()
                         {
                           document.addEventListener(
                             'fortifi-drawer-state-changed', function (e)
                             {
                               if(e.detail.position == 'left')
                               {
                                 this.$.ah.style.left = (e.detail.offset + 24) + 'px';
                               }
                               else if(e.detail.position == 'right')
                               {
                                 this.$.ah.style.right = (e.detail.offset + 24) + 'px';
                               }
                             }.bind(this)
                           );
                           this.async(function () {this._viewChanged(this._lock, this._peek);});
                         },
        _viewChanged:    function (lock, peek, narrow)
                         {
                           var drawer = this.drawer;
                           if(drawer)
                           {
                             if(this._touchEnabled())
                             {
                               drawer.setMinState(0);
                             }
                             else
                             {
                               drawer.setMinState(1);
                             }

                             if(lock)
                             {
                               drawer.setState(2);
                             }
                             else if(((narrow && !this._touchEnabled()) || peek) && (drawer.state < 1 || narrow))
                             {
                               drawer.setState(1);
                             }
                           }
                         },
        _updateMaxState: function (narrow)
                         {
                           if(this.drawer)
                           {
                             this.drawer.maxState = narrow ? 1 : 2;
                           }
                         },
        setDrawerState:  function (state)
                         {
                           var drawer = this.drawer;
                           drawer.setState(state);
                           if(state == 1)
                           {
                             drawer.close();
                           }
                         },

        /**
         * Retrieve the drawer element for this app
         * @returns {Element}
         */
        get drawer()
        {
          return this.querySelector('#appDrawer') || this.root.querySelector('#appDrawer');
        }
      }
    )
  </script>
</dom-module>
