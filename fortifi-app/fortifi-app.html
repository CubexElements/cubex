<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../fortifi-drawer/fortifi-drawer.html">
<link rel="import" href="../fortifi-drawer/fortifi-drawer-content.html">
<link rel="import" href="../fortifi-breadcrumb/fortifi-breadcrumb.html">
<link rel="import" href="../fortifi-app/fortifi-app-definition.html">
<link rel="import" href="../fortifi-app/fortifi-app-header.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../iron-media-query/iron-media-query.html">
<link rel="import" href="../../fort-behavior/fort-touch-enabled-behavior.html">
<link rel="import" href="../../fort-behavior/fort-service-behavior.html">
<link rel="import" href="../../app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../app-layout/app-header/app-header.html">
<link rel="import" href="../../app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../fortifi-effects/displace-element.html">


<!--
An element providing a solution to no problem in particular.

Example:

    <fortifi-app>
    </fortifi-app>


@demo demo/index.html
@hero hero.svg
-->

<dom-module id="fortifi-app" attributes="app-data page-data integrations">
  <template>
    <style>
      :host {
        display: block;
        --fortifi-drawer-peek-width: 56px;
      }

      fortifi-app-header {
        border-top-left-radius: 3px;
        border-top-right-radius: 3px;

      }

      app-header-layout {
        padding-bottom: 24px;
        margin: 0 24px;
        min-width: 100px;
      }

      #app-container {
        border-bottom-left-radius: 3px;
        border-bottom-right-radius: 3px;
        @apply --theme-600;
        @apply --shadow-elevation-2dp;

        border-top-left-radius: 3px;
        border-top-right-radius: 3px;

        overflow: hidden;
      }

      #app-content {
        margin: 40px;
      }

      fortifi-breadcrumb {
        margin: 0 -24px;
        color: var(--theme-text);
      }

      :host app-toolbar {
        padding: 0;
        height: auto;
      }

      :host fortifi-app-header {
        /*@apply --shadow-elevation-2dp;*/
      }

      :host app-header {
        box-sizing: border-box;
        border-top: solid transparent var(--fortifi-drawer-offset-top, 0);
        transition: left ease 0.2s, right ease 0.2s !important;
      }

      :host #hero {
        overflow: hidden;
        position: relative;
        @apply --accent-700;
      }

      :host([drawer-disabled]) {
        --fortifi-drawer-peek-width: 0;
        --fortifi-drawer-width: 0;
      }
    </style>

    <iron-media-query query="(max-width: 375px)" query-matches="{{narrow}}"></iron-media-query>
    <iron-media-query query="(min-width: 1000px)" query-matches="{{_peek}}"></iron-media-query>
    <iron-media-query query="(min-width: 1300px)" query-matches="{{_lock}}"></iron-media-query>

    <fort-preferences name="appDrawerPosition" value="{{appDrawerState}}"></fort-preferences>
    <fortifi-drawer id="appDrawer" hover-popout swipe-open position="left" preferred-state="{{appDrawerState}}">
      <slot slot="drawer-content" name="drawer-content"></slot>
      <app-header-layout id="ahl">
        <app-header id="ah" slot="header" reveals condenses effects="displace-element waterfall">
          <fortifi-breadcrumb></fortifi-breadcrumb>
          <app-toolbar sticky>
            <fortifi-app-header back-path="[[pageData.backPath]]" actions="[[integrations.HeaderActions]]"
                                menu="[[integrations.HeaderMenuItems]]">
              <template is="dom-if" if="[[pageData.icon]]">
                <fort-icon slot="icon" src="[[pageData.icon]]"></fort-icon>
              </template>
              <h1 slot="header">[[pageData.title]]</h1>
              <div displace id="hero" slot="hero">
                <slot name="hero"></slot>
              </div>
            </fortifi-app-header>
          </app-toolbar>
        </app-header>

        <div id="app-container">
          <div id="app-content">
            <slot></slot>
          </div>
        </div>
      </app-header-layout>
    </fortifi-drawer>

  </template>
  <script>
    Polymer(
      {
        is:              'fortifi-app',
        behaviors:       [Polymer.FortTouchEnabledBehavior, Polymer.FortServiceBehavior],
        properties:      {
          narrow:         {type: Boolean, value: true, reflectToAttribute: true, observer: '_updateMaxState'},
          appData:        {type: Object},
          pageData:       {type: Object, observer: '_pageUpdated'},
          drawerDisabled: {
            type:               Boolean,
            value:              false,
            reflectToAttribute: true
          },
          _lock:          {type: Boolean, value: false},
          _peek:          {type: Boolean, value: false}
        },
        observers:       [
          '_viewChanged(_lock,_peek,narrow)',
          '_updateDrawer(appData)'
        ],
        _updateDrawer:   function (appData)
                         {
                           if(!(appData && appData.Navigation && appData.Navigation.length))
                           {
                             this.$.appDrawer.setMaxState(0);
                           }
                           else
                           {
                             this.$.appDrawer.setMaxState(2);
                           }
                         },
        _pageUpdated:    function ()
                         {
                           Polymer.RenderStatus.afterNextRender(
                             this, function ()
                             {
                               this.$.ahl.resetLayout();
                             }
                           );
                         },
        ready:           function ()
                         {
                           document.addEventListener(
                             'fortifi-drawer-state-changed', function (e)
                             {
                               if(e.detail.position == 'left')
                               {
                                 this.$.ah.style.left = (e.detail.offset + 24) + 'px';
                               }
                               else if(e.detail.position == 'right')
                               {
                                 this.$.ah.style.right = (e.detail.offset + 24) + 'px';
                               }
                             }.bind(this)
                           );
                           this.async(function () {this._viewChanged(this._lock, this._peek);});
                         },
        _viewChanged:    function (lock, peek, narrow)
                         {
                           var drawer = this.drawer;
                           if(drawer)
                           {
                             if(this._touchEnabled())
                             {
                               drawer.setMinState(0);
                             }
                             else
                             {
                               drawer.setMinState(1);
                             }

                             if(lock)
                             {
                               drawer.setState(2);
                             }
                             else if(((narrow && !this._touchEnabled()) || peek) && (drawer.state < 1 || narrow))
                             {
                               drawer.setState(1);
                             }
                           }
                         },
        _updateMaxState: function (narrow)
                         {
                           if(this.drawer)
                           {
                             this.drawer.maxState = narrow ? 1 : 2;
                           }
                         },
        setDrawerState:  function (state)
                         {
                           var drawer = this.drawer;
                           drawer.setState(state);
                           if(state == 1)
                           {
                             drawer.close();
                           }
                         },

        /**
         * Retrieve the drawer element for this app
         * @returns {Element}
         */
        get drawer()
        {
          return this.querySelector('#appDrawer') || this.root.querySelector('#appDrawer');
        }
      }
    )
  </script>
</dom-module>
