<link href="../../polymer/polymer.html" rel="import">
<link href="../fortifi-registry/fortifi-registry.html" rel="import">
<link href="../fortifi-organisation/fortifi-organisation.html" rel="import">
<link href="../../iron-selector/iron-selector.html" rel="import">
<link href="../../paper-button/paper-button.html" rel="import">
<link href="../../fort-animbg/fort-animbg.html" rel="import">
<link href="../../fort-list/fort-list-menu.html" rel="import">
<link href="../../fort-list/fort-list-group.html" rel="import">
<link href="../../fort-list/fort-li.html" rel="import">
<link href="../../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html" rel="import">
<link href="../../fort-behavior/fort-i18n-behavior.html" rel="import">
<link href="../../fort-behavior/fort-service-behavior.html" rel="import">

<dom-module id="fortifi-shell-drawer">
  <template>
    <style>
      :host {
        display: block;
        overflow: auto;
        height: 100%;
        --fort-animbg-background-color: var(--accent-700-color);
      }

      #user-view {
        position: relative;
        width: 100%;
        height: 146px;
        @apply(--paper-font-body2);
        color: var(--accent-700-text-color);
        border-bottom: 1px solid rgba(0, 0, 0, 0.2);
      }

      #user-view strong,
      #user-view span {
        padding-left: 98px;
        display: block;
        padding-top: 26px;
      }

      #user-view span {
        padding-top: 0;
        opacity: var(--light-secondary-opacity);
      }

      #user-view img {
        border-radius: 50%;
        border: solid 3px rgba(255, 255, 255, 0.4);
        width: 64px;
        height: 64px;
        position: absolute;
        top: 17px;
        left: 13px;
      }

      .toggle {

        display: block;
        position: absolute;
        top: 90px;
        left: 0;
        right: 0;
        margin: 0;
        padding: 0 16px;
        cursor: pointer;
        text-align: left;

        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
        user-select: none;

        text-transform: none;
        @apply(--paper-font-body2);
        height: 56px;
        line-height: 56px;
      }

      .toggle iron-icon {
        float: right;
        top: 18px;
      }

      .closer {
        position: absolute;
        z-index: 100;
        top: 0;
        left: 0;
        right: 0;
        height: 90px;
      }

      #drawerPanels {
        height: 100%;
        width: 100%;
      }

      :host fort-list-menu {
        --fort-list-filter-color: var(--primary-800-text-secondary-color);
        --fort-list-filter-focus-color: var(--primary-800-text-color);
      }

      :host fort-li {
        @apply --primary-700;
      }
    </style>

    <fortifi-organisation organisation="{{organisation}}" organisations="{{_organisations}}"></fortifi-organisation>

    <fortifi-registry org-data="{{_orgRegistryData}}"></fortifi-registry>

    <fort-animbg id="user-view" size="80">
      <fort-resource auto auth url="//[[getServiceHost('apps')]]/fortifi/whoami/whoami.json"
                     data="{{whoami}}"></fort-resource>
      <paper-button on-tap="_toggleParent" class="closer"></paper-button>
      <img src="../demo/resources/images/avatar/default-64.png">
      <strong>[[whoami.FirstName]] [[whoami.LastName]]</strong>
      <span>[[whoami.Username]]</span>
      <paper-button on-tap="toggleDrawer" class="toggle" selected-drawer="{{selectedItem}}">
        [[organisation.name]]
        <iron-icon icon="[[_icon]]"></iron-icon>
      </paper-button>
    </fort-animbg>
    <div style="position: relative;">
      <iron-selector selected="0" id="drawerPanels">
        <slot></slot>
        <fortifi-shell-drawer-panel>
          <fort-list-menu show-filter filter-label="{{i18n('filter_apps')}}">
            <template is="dom-repeat" items="[[__appGroups(_orgRegistryData)]]" as="group">
              <fort-list-group title="[[group.name]]">
                <template is="dom-repeat" items="[[group.apps]]" as="app">
                  <a href="/[[organisation.id]]/[[app.vendor_id]]/[[app.id]]" on-tap="_toggleParent">
                    <fort-li>
                      <fort-icon slot="icon" icon="[[app.icon]]"></fort-icon>
                      [[app.name]]
                    </fort-li>
                  </a>
                </template>
              </fort-list-group>
            </template>
          </fort-list-menu>
        </fortifi-shell-drawer-panel>
        <fortifi-shell-drawer-panel>
          <fort-list-menu show-filter filter-label="{{i18n('filter_orgs')}}">
            <fort-list-group title="{{i18n('all_organisations')}}">
              <template is="dom-repeat" items="[[organisations]]">
                <a href="/[[item.id]]">
                  <fort-li>
                    <fort-icon slot="icon" icon="communication:business"></fort-icon>
                    [[item.name]]
                  </fort-li>
                </a>
              </template>
            </fort-list-group>
          </fort-list-menu>
        </fortifi-shell-drawer-panel>
      </iron-selector>
    </div>
  </template>

  <script>
    Polymer(
      {
        is:          'fortifi-shell-drawer',
        properties:  {
          resources:        {
            type:  Object,
            value: {
              "en": {
                "filter_apps":       "Filter Applications",
                "filter_orgs":       "Filter Organisations",
                "all_organisations": "All Organisations"
              },
              "fr": {
                "filter_apps":       "Filtre Applications",
                "filter_orgs":       "Filtre les organisations",
                "all_organisations": "Toutes les organisations"
              }
            }
          },
          selectedItem:     {
            type:  Number,
            value: 0
          },
          _icon:            {
            type:  String,
            value: "icons:arrow-drop-down"
          },
          _orgRegistryData: {type: Object},
          organisation:     {type: Object},
          organisations:    {type: Array},
          avatar:           {
            type:  String,
            value: "resources/images/avatar/default-64.png"
          },
          headColor:        {
            type: String
          }
        },
        behaviors:   [
          Polymer.IronA11yKeysBehavior,
          Polymer.FortI18nBehavior,
          Polymer.FortServiceBehavior
        ],
        keyBindings: {
          ',': 'toggleDrawer'
        },
        attached:    function ()
                     {
                       this.keyEventTarget = document.body;
                     },
        observers:   ['_updateOrgs(_organisations)'],
        _updateOrgs: function (orgs)
                     {
                       this.organisations = Object.keys(orgs).map(function (key) { return orgs[key]; });
                     },

        _toggleParent: function ()
                       {
                         this.fire('closeParent', {});
                       },
        toggleDrawer:  function ()
                       {
                         this.$.drawerPanels.selectNext();
                         this.selectedItem = this.$.drawerPanels.selected;
                         if(this.selectedItem == 1)
                         {
                           this._icon = "icons:arrow-drop-up";
                         }
                         else if(this.selectedItem == 0)
                         {
                           this._icon = "icons:arrow-drop-down";
                         }
                       },

        __appGroups: function (orgRegistry)
                     {
                       var groups = {};
                       if(orgRegistry)
                       {
                         for(var idx in orgRegistry.AppSummary)
                         {
                           if(orgRegistry.AppSummary.hasOwnProperty(idx))
                           {
                             var app = orgRegistry.AppSummary[idx];
                             if(!groups[app.category])
                             {
                               groups[app.category] = {name: app.category, apps: []};
                             }
                             var group = groups[app.category];
                             group.apps.push(app);
                           }
                         }
                       }
                       return Object.keys(groups).map(function (i) {return groups[i];});
                     }
      }
    );
  </script>
</dom-module>
